{%extends 'store/base.html'%}
{%block head%}
<script>
	function total() {
	    total_price=0
		count=0
		$('.col07').each(function () {
			num=parseFloat($(this).prev().find('.num_show').val())
			price=parseFloat($(this).siblings('.col05').children().text())
			totals=num*price
			$(this).children().text((num*price).toFixed(2))
			if ($(this).siblings('.col01').children().prop('checked')){
			    total_price=total_price+totals
				count++
			}
        })
        $('.settlements').children('.col03').find('em').text((total_price).toFixed(2))
		$('.settlements').children('.col03').find('b').text(count)
    }
	$(function () {
	    total()
	    $('.add').click(function () {
	        num=parseInt($(this).next().val())
			kucun=parseInt($(this).parents('.cart_list_td').children('.col03').find('em').text())
			num=num+1
			if (num>kucun){
	            num=kucun
			}
			$(this).next().val(num)
			goods_id=$(this).parents('.cart_list_td').attr('id')
			$.get('/cart/add'+goods_id+'_1/',function (data) {
            })
			total()
        })
		$('.minus').click(function () {
			num=parseFloat($(this).prev().val())
			num=num-1
			if(num<1){
			    num=1
			}
			else{
			    goods_id=$(this).parents('.cart_list_td').attr('id')
				$.get('/cart/add'+goods_id+'_-1/',function (data) {
            })
			}
			$(this).prev().val(num)

			total()
        })
		$('.num_show').blur(function () {
            kucun=parseInt($(this).parents('.cart_list_td').children('.col03').find('em').text())
		    num=parseFloat($(this).val())
			if(num<1){
                num=1
			}
			if(num>kucun){
			    num=kucun
			}
			$(this).val(num)
			goods_id=$(this).parents('.cart_list_td').attr('id')
			$.get('/cart/numadd'+goods_id+'_'+num+'/',function (data) {

            })
		  	total()
        })
		$('.col08').each(function () {
		    $(this).click(function () {
		        goods_id=$(this).parents('.cart_list_td').attr('id')
				$.get('/cart/delete'+goods_id+'/',function (data) {
					$('ul').remove('#'+goods_id)
					$('.goods_count').text(data.cart_count)
					$('.total_count').children().text(data.cart_count)
                })
            })
        })
//		全选全消
		$('.settlements').children('.col01').children().click(function () {
		    state=$(this).prop('checked')
		    if (state){
		        $('.cart_list_td').each(function () {
					$(this).children('.col01').children().prop('checked','checked')
                })
			}
			else{
		        $('.cart_list_td').each(function () {
					$(this).children('.col01').children().prop('checked','')
                })
			}
			total()
        })
//	部分选消
		$('.cart_list_td').children('.col01').children().each(function () {
		    $(this).click(function () {
		        if($(':checkbox:not(#check_all)').length!=$(':checked:not(#check_all)').length){
		            $('#check_all').prop('checked',false)
				}
				else{
		           $('#check_all').prop('checked',true)
				}
		        total()
            })
        })
    })
</script>

{%endblock head%}
{%block content%}

	<div class="total_count">全部商品<em>{{cart_count}}</em>件</div>
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>

<form method="get" action="/place_order/">
{%for cart in carts%}
	<ul class="cart_list_td clearfix" id={{cart.goods_id}}>
		<li class="col01"><input type="checkbox" name="cart_id" value={{cart.id}} checked="checked"></li>
		<li class="col02"><img src="/static/{{cart.goods.gpic}}"></li>
		<li class="col03">{{cart.goods.gtitle}}
			<br><span style="color:red;font-weight: bold;font-size:14px;">
				库存：<em >{{cart.goods.gkucun}}</em></span>
		</li>

		<li class="col04">{{cart.goods.gunit}}</li>
		<li class="col05"><span>{{cart.goods.gprice}}</span>元</li>
		<li class="col06">
			<div class="num_add">
				<a href="javascript:;" class="add fl">+</a>
				<input type="text"  class="num_show fl" value={{cart.count}}>
				<a href="javascript:;" class="minus fl">-</a>	
			</div>
		</li>
		<li class="col07"><span>{{cart.goods.gprice}}</span>元</li>
		<li class="col08"><a href="javascript:;">删除</a></li>
	</ul>
{%endfor%}

	<ul class="settlements">
		<li class="col01"><input type="checkbox" name="" checked="checked" id="check_all"></li>
		<li class="col02">全选</li>
		<li class="col03">合计(不含运费)：<span>¥</span><em>0</em><br>共计<b>0</b>件商品</li>
		<li class="col04"><input type="submit" value="去结算"></li>
	</ul>
</form>
{%endblock content%}